Spec: Thanh toán (Checkout)

---
Cart_Add

| Mục | Nội dung |
|---|---|
| Mục tiêu | Thêm/xóa sản phẩm khỏi giỏ |
| Đầu vào | `productId`, số lượng, biến thể |
| Xử lý | Kiểm tra tồn kho; hợp lệ giá |
| Đầu ra | Trạng thái giỏ hàng |
| Tích hợp ngoài | Không trực tiếp |
| Ràng buộc | Idempotent; giới hạn số lượng |
| Lỗi | `OUT_OF_STOCK`, `INVALID_VARIANT` |
| KPI | Tỉ lệ thêm giỏ thành công |

---
Cart_Pricing

| Mục | Nội dung |
|---|---|
| Mục tiêu | Tính giá cuối cùng không bao gồm vận chuyển |
| Đầu vào | Mục trong giỏ, mã giảm giá, thuế (nếu áp dụng) |
| Xử lý | Áp dụng khuyến mãi; tính thuế; làm tròn |
| Đầu ra | Tổng tiền phải trả |
| Tích hợp ngoài | Không trực tiếp |
| Ràng buộc | Idempotent; kiểm soát chênh lệch giá |
| Lỗi | `PRICING_RULE_CONFLICT` |
| KPI | Tốc độ tính giá; tỉ lệ sai giá |

---
Pay_Create

| Mục | Nội dung |
|---|---|
| Mục tiêu | Tạo phiên thanh toán |
| Đầu vào | Tổng tiền, đơn vị tiền tệ, giỏ hàng |
| Xử lý | Tạo phiên, ghi nhận order draft |
| Đầu ra | `paymentSessionId`, URL thanh toán |
| Tích hợp ngoài | `actorPayment` |
| Ràng buộc | Chống gian lận; xác minh số tiền |
| Lỗi | `PAYMENT_SESSION_FAILED` |
| KPI | Tỉ lệ tạo phiên thành công |

---
Pay_Capture

| Mục | Nội dung |
|---|---|
| Mục tiêu | Xác nhận/ghi nhận thanh toán |
| Đầu vào | `paymentSessionId`, callback từ PSP |
| Xử lý | Xác thực chữ ký; ghi nhận hóa đơn |
| Đầu ra | Trạng thái thanh toán, biên lai |
| Tích hợp ngoài | `actorPayment` |
| Ràng buộc | Idempotent; xử lý thất bại an toàn |
| Lỗi | `PAYMENT_FAILED`, `SIGNATURE_INVALID` |
| KPI | Tỉ lệ capture thành công |

---
Order_Confirm

| Mục | Nội dung |
|---|---|
| Mục tiêu | Chuyển order thành công, phát hành xác nhận |
| Đầu vào | Trạng thái thanh toán OK |
| Xử lý | Tạo order; gửi email/SMS; cập nhật tồn kho |
| Đầu ra | `orderId`, xác nhận gửi |
| Tích hợp ngoài | Nhà kho/vận chuyển (tuỳ) |
| Ràng buộc | Idempotent; atomic với tồn kho |
| Lỗi | `ORDER_CREATE_FAILED` |
| KPI | Tỉ lệ xác nhận đơn |

---
Webhook_Handle

| Mục | Nội dung |
|---|---|
| Mục tiêu | Xử lý webhook từ PSP |
| Đầu vào | Sự kiện PSP, chữ ký |
| Xử lý | Xác thực; cập nhật trạng thái; retry/backoff |
| Đầu ra | ACK, log sự kiện |
| Tích hợp ngoài | `actorPayment` |
| Ràng buộc | Bảo mật chữ ký; idempotent theo eventId |
| Lỗi | `WEBHOOK_INVALID`, `WEBHOOK_DUPLICATE` |
| KPI | Độ trễ xử lý; tỉ lệ lỗi webhook |
