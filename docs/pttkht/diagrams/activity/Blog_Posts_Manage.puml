@startuml
skinparam linetype ortho
start
:Đọc cookie token;
if (Hợp lệ?) then (Có)
  :Kiểm tra vai trò Author/Admin;
  if (Đủ quyền?) then (Có)
    :Đọc action (create/update/delete/publish/listDashboard);
    if (Action?) then (create)
      :Parse JSON/FormData: title, content, tags, coverImage;
      :Validate bắt buộc;
      if (Hợp lệ?) then (Có)
        if (Có coverImage?) then (Có)
          :Upload ảnh bìa lên S3;
        endif
        :Prisma: tạo post (owner=userId, status=draft/published);
        :200: Trả post mới;
      else (Không)
        :400: Missing/Invalid fields;
      endif
    elseif (update)
      :Parse body: title/content/tags/coverImage;
      :Prisma: tìm post theo postId;
      if (Tồn tại?) then (Có)
        :Validate quyền sở hữu hoặc Admin;
        if (Đủ quyền?) then (Có)
          if (Có coverImage mới?) then (Có)
            :Upload ảnh bìa lên S3;
          endif
          :Prisma: cập nhật post;
          :200: Trả post cập nhật;
        else (Không)
          :403: Forbidden;
        endif
      else (Không)
        :404: Không tồn tại;
      endif
    elseif (delete)
      :Prisma: tìm post theo postId;
      if (Tồn tại?) then (Có)
        :Validate quyền sở hữu hoặc Admin;
        if (Đủ quyền?) then (Có)
          :Prisma: xoá (soft/hard theo chính sách);
          :200: Trả success;
        else (Không)
          :403: Forbidden;
        endif
      else (Không)
        :404: Không tồn tại;
      endif
    elseif (publish)
      :Prisma: tìm post theo postId;
      if (Tồn tại?) then (Có)
        :Validate quyền sở hữu hoặc Admin;
        if (Đủ quyền?) then (Có)
          :Prisma: chuyển status draft↔published;
          :200: Trả success;
        else (Không)
          :403: Forbidden;
        endif
      else (Không)
        :404: Không tồn tại;
      endif
    else (listDashboard)
      :Parse query: page, status, tag;
      :Prisma: tải posts theo owner=userId hoặc tất cả (Admin);
      :200: Trả danh sách quản trị;
    endif
    end
  else (Không)
    :403: Forbidden;
    end
  endif
else (Không)
  :401: Unauthorized;
  end
endif
@enduml
