@startuml
skinparam linetype ortho
start
:Đọc provider từ query;
if (Hỗ trợ provider?) then (Stripe)
  :Đọc header stripe-signature và secret;
  if (Có signature và secret?) then (Có)
    :Construct event từ raw body;
    if (Chữ ký hợp lệ?) then (Có)
      :Đọc payment_intent, metadata {packageId,userId};
      if (Có metadata?) then (Có)
        if (event.type là payment_intent.succeeded?) then (Có)
          :Kiểm tra trùng stripePaymentId;
          if (Đã xử lý?) then (Có)
            :200: Already processed;
            end
          else (Không)
            :Tìm package trong TOKEN_CONFIG;
            if (Tồn tại gói?) then (Có)
              :Prisma transaction: tạo purchase + tăng tokenBalance;
              :Log PURCHASE_COMPLETED;
              :200: Payment processed successfully;
              end
            else (Không)
              :400: Package not found;
              end
            endif
          endif
        else (Không)
          :400: Payment not completed;
          end
        endif
      else (Không)
        :400: Missing metadata;
        end
      endif
    else (Không)
      :400: Invalid Stripe signature;
      end
    endif
  else (Không)
    :400: Thiếu chữ ký/secret;
    end
  endif
else (Không)
  :400: Unsupported/Missing provider;
  end
endif
@enduml
