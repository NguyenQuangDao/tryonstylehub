@startuml
skinparam linetype ortho
start
:Đọc cookie token;
if (Hợp lệ?) then (Có)
  :Đọc action (create/list/update/delete/setDefault);
  if (Action?) then (create)
    :Parse JSON/FormData: model info, image;
    :Validate bắt buộc;
    if (Hợp lệ?) then (Có)
      :Upload ảnh lên S3;
      :Prisma: tạo virtual model (gắn userId);
      :200: Trả model mới;
    else (Không)
      :400: Missing/Invalid fields;
    endif
  elseif (update)
    :Parse JSON/FormData: name/desc/image;
    :Validate bắt buộc;
    :Prisma: tìm model theo modelId + userId;
    if (Tồn tại?) then (Có)
      if (Có ảnh mới?) then (Có)
        :Upload ảnh lên S3;
      endif
      :Prisma: cập nhật model;
      :200: Trả model cập nhật;
    else (Không)
      :404: Model không tồn tại;
    endif
  elseif (delete)
    :Validate quyền sở hữu;
    :Prisma: tìm model theo modelId + userId;
    if (Tồn tại?) then (Có)
      :Prisma: xoá model;
      :200: Trả success;
    else (Không)
      :404: Model không tồn tại;
    endif
  elseif (setDefault)
    :Validate quyền sở hữu;
    :Prisma: tìm model theo modelId + userId;
    if (Tồn tại?) then (Có)
      :Prisma: unset default các model khác của user;
      :Prisma: set default cho modelId;
      :200: Trả success;
    else (Không)
      :404: Model không tồn tại;
    endif
  else (list)
    :Prisma: lấy danh sách models theo userId (phân trang/sort);
    :200: Trả danh sách models;
  endif
  end
else (Không)
  :401: Unauthorized;
  end
endif
@enduml
