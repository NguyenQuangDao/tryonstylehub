@startuml
skinparam linetype ortho
start
:Tải ảnh người dùng (JPEG/PNG ≤10MB);
if (Hợp lệ?) then (Có)
  :Làm sạch EXIF, quét virus;
  :Phát sinh imageId và URL tạm;
else (Không)
  :400: INVALID_FORMAT / FILE_TOO_LARGE;
  stop
endif
:Chọn productId, biến thể, size;
:Kiểm tra danh mục/giá và tồn kho;
if (Item khả dụng?) then (Có)
  :Ánh xạ size theo brand;
  :Sinh cấu hình item đã chọn;
else (Không)
  :409: ITEM_NOT_FOUND / SIZE_UNAVAILABLE;
  stop
endif
:Kiểm tra FASHN_API_KEY;
if (Có API key?) then (Có)
  :Kiểm tra số dư token theo tier quality;
  if (Đủ token?) then (Có)
    :Chuyển ảnh sang Base64;
    :Build payload (model tryon-v1.6, inputs);
    :Gọi FASHN predictions.run → predId;
    if (Nhận predId?) then (Có)
      :Polling trạng thái mỗi 2s ≤180s;
      if (Trạng thái?) then (completed)
        :Hậu xử lý ảnh: đọc metadata, resize nếu cần;
        :Encode PNG/JPEG;
        :Upload S3 theo prefix users/{userId}/tryon;
        :Cập nhật gallery.json (prepend entries);
        :Charge tokens theo chất lượng;
        :200: Trả danh sách images;
      elseif (Trạng thái?) then (failed)
        :500: Prediction failed;
      else (timeout)
        :504: Maximum polling time exceeded;
      endif
    else (Không)
      :Xử lý APIError: 401/403 invalid key; 429 rate limit; khác;
      stop
    endif
  else (Không)
    :401/402: createInsufficientTokensResponse;
    stop
  endif
else (Không)
  :500: Missing FASHN_API_KEY;
  stop
endif
:Expose trạng thái job qua /api/tryon/status/[jobId];
stop
@enduml

