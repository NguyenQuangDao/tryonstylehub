@startuml
skinparam linetype ortho
start
:Đọc action (listPublic/view);
if (Action?) then (listPublic)
  :Parse query: page, q, tag;
  :Validate tham số;
  :Tạo cacheKey theo query;
  if (Có cache?) then (Có)
    :200: Trả danh sách từ cache;
    end
  else (Không)
    :Prisma: tải bài viết status=published;
    :Enrich: excerpt, coverUrl (presigned nếu cần), tags;
    if (Có q?) then (Có)
      :Rank theo tiêu đề/nội dung/tags;
    endif
    :Phân trang + sắp xếp mới nhất;
    :setCache(cacheKey, payload, TTL=5m);
    :200: Trả danh sách;
    end
  endif
elseif (view)
  :Parse slug/postId;
  :Prisma: lấy post status=published;
  if (Tồn tại?) then (Có)
    :Enrich: render nội dung, coverUrl, tags;
    :Prisma: tải bình luận đã duyệt;
    :200: Trả chi tiết bài viết + comments;
    end
  else (Không)
    :404: Không tồn tại hoặc chưa xuất bản;
    end
  endif
endif
@enduml
